- name: Setup local Fedora system for development
  hosts: localhost
  connection: local
  gather_facts: true
  vars_files:
    - vars/user_vars.yml
  tasks:
    - name: Setup repositories and install development packages
      tags: superuser, packages
      become: true
      block:
        - name: Add repository for github cli
          ansible.builtin.yum_repository:
            name: gh-cli
            file: gh-cli
            description: Github CLI
            baseurl: https://cli.github.com/packages/rpm
            gpgkey: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x23F3D4EA75716059
            gpgcheck: true
        - name: Add repository for vs code
          ansible.builtin.yum_repository:
            name: vscode
            file: vscode
            description: Visual Studio Code
            baseurl: https://packages.microsoft.com/yumrepos/vscode
            gpgkey: https://packages.microsoft.com/keys/microsoft.asc
            gpgcheck: true
        - name: Install dev packages
          ansible.builtin.dnf5:
            name: "{{ dev_packages }}"
            state: present
    - name: Git configuration
      tags: user, git
      become: false
      block:
        - name: Setup git user
          community.general.git_config:
            name: user.name
            scope: global
            value: "{{ GIT_USERNAME }}"
        - name: Setup git email
          community.general.git_config:
            name: user.email
            scope: global
            value: "{{ GIT_EMAIL }}"
        - name: Setup git default branch
          community.general.git_config:
            name: init.defaultbranch
            scope: global
            value: main
        - name: Setup graph git alias
          community.general.git_config:
            name: alias.graph
            scope: global
            value: log --graph --abbrev-commit --date=relative --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(cyan)<%an>%Creset'

    - name: install zed preview
      tags: zed, user
      become: false
      block:
        - name: Check if Zed binary exists
          ansible.builtin.stat:
            path: "{{ ansible_facts.user_dir }}/.local/bin/zed"
          register: zed_binary

        - name: Install Zed editor if not present
          block:
            - name: Download the Zed installation script
              ansible.builtin.get_url:
                url: https://zed.dev/install.sh
                dest: /tmp/install_zed.sh
                mode: "0755"

            - name: Run the Zed installation script
              ansible.builtin.command: /tmp/install_zed.sh
              environment:
                ZED_CHANNEL: preview
              register: zed_install_result
              changed_when: "'Installed' in zed_install_result.stdout"

            - name: Remove the installation script
              ansible.builtin.file:
                path: /tmp/install_zed.sh
                state: absent
          # Now zed_binary is defined because the task above finished first
          when: not zed_binary.stat.exists
